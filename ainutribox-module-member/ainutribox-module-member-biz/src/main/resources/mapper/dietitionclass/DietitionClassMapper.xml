<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ainutribox.module.member.dal.mysql.dietitionclass.DietitionClassMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->

    <select id="selectUserClassPage" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.AppUserClassVO">
        select
        dc.id,
        dc.name,
        dc.pic_url,
        dc.description,
        dc.dietition_id,
        dc.course_title,
        dc.class_url,
        dc.class_type,
        dc.info_pic,
        dc.category_id,
        dc.price,
        dc.vip_price,
        dc.tags,
        dc.comment_num,
        dc.like_num,
        dc.score,
        dc.create_time,
        dc.actual_people,
        dc.virtual_people,
        dc.virtual_people + dc.actual_people as allPeople,
        dc.comment_num + dc.actual_people + dc.comment_num + dc.like_num + dc.score + dc.virtual_people as comprehensive,
        di.nick_name,
        di.pic,
        di.level
            from member_dietition_class dc
            left join member_dietition_info di on dc.dietition_id = di.user_id
            where dc.status = 0 and dc.deleted = 0
            <if test="null != classDTO.name and classDTO.name != ''">
                and dc.name like concat(#{classDTO.name},'%')
            </if>
            <if test="null != classDTO.courseTitle and classDTO.courseTitle !=''">
                and  dc.course_title like concat(#{classDTO.courseTitle},'%')
            </if>
            <if test="null != classDTO.dietitionId">
                and  dc.dietition_id = #{classDTO.dietitionId}
            </if>
            <if test="null != classDTO.categoryId">
                and  dc.category_id = #{classDTO.categoryId}
            </if>
            <choose>
                <when test="null != classDTO.orderBy and classDTO.orderBy == 'allPeople'">
                    order by  allPeople desc
                </when>
                <when test="null != classDTO.orderBy and classDTO.orderBy == 'comprehensive'">
                    order by comprehensive desc
                </when>
                <otherwise>
                    order by dc.create_time desc
                </otherwise>
            </choose>
    </select>
    <select id="selectUserJoinClassList" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.AppUserClassVO">
        select
        dc.id,
        dc.name,
        dc.pic_url,
        dc.description,
        dc.dietition_id,
        dc.course_title,
        dc.class_url,
        dc.class_type,
        dc.info_pic,
        dc.category_id,
        dc.price,
        dc.vip_price,
        dc.tags,
        dc.comment_num,
        dc.like_num,
        dc.score,
        dc.create_time,
        dc.actual_people,
        dc.virtual_people,
        dc.virtual_people + dc.actual_people as allPeople,
        dc.comment_num + dc.actual_people + dc.comment_num + dc.like_num + dc.score + dc.virtual_people as comprehensive,
        di.nick_name,
        di.pic,
        di.level,
        jc.create_time as joinTime
        from member_join_class jc
        left join member_dietition_class dc on jc.class_id = dc.id
        left join member_dietition_info di on dc.dietition_id = di.user_id
        where jc.member_id = #{userId}
    </select>
    <select id="selectUserBuyClassList" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.AppUserClassVO">
        select
            dc.id,
            dc.name,
            dc.pic_url,
            dc.description,
            dc.dietition_id,
            dc.course_title,
            dc.class_url,
            dc.class_type,
            dc.info_pic,
            dc.category_id,
            dc.price,
            dc.vip_price,
            dc.tags,
            dc.comment_num,
            dc.like_num,
            dc.score,
            dc.create_time,
            dc.actual_people,
            dc.virtual_people,
            dc.virtual_people + dc.actual_people as allPeople,
            dc.comment_num + dc.actual_people + dc.comment_num + dc.like_num + dc.score + dc.virtual_people as comprehensive,
            di.nick_name,
            di.pic,
            di.level,
            pc.create_time as buyTime
        from member_pay_class pc
            left join member_dietition_class dc on pc.class_id = dc.id
            left join member_dietition_info di on dc.dietition_id = di.user_id
        where pc.user_id = #{userId}
    </select>

    <select id="selectClassVo" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.AppUserClassVO">
        select
        dc.id,
        dc.name,
        dc.pic_url,
        dc.description,
        dc.dietition_id,
        dc.course_title,
        dc.class_url,
        dc.class_type,
        dc.info_pic,
        dc.category_id,
        dc.price,
        dc.vip_price,
        dc.tags,
        dc.comment_num,
        dc.like_num,
        dc.score,
        dc.create_time,
        dc.actual_people,
        dc.virtual_people,
        dc.virtual_people + dc.actual_people as allPeople,
        dc.comment_num + dc.actual_people + dc.comment_num + dc.like_num + dc.score + dc.virtual_people as comprehensive,
        di.nick_name,
        di.pic,
        di.level,
        di.info_pic as dietitionInfoPic,
        cc.name as categoryName
        from member_dietition_class dc
        left join member_dietition_info di on dc.dietition_id = di.user_id
        left join member_dietition_class_category cc on dc.category_id = cc.id
        where dc.status = 0 and dc.deleted = 0 and dc.id = #{classId}
    </select>

    <select id="getClassAverageScore" resultType="integer">
        select IFNULL(ROUND(AVG(scores), 1), 0)*10
        from member_dietition_class_comment
        where class_id = #{classId};
    </select>

    <select id="selectDietitionClassList" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.AppUserClassVO">
        select
        dc.id,
        dc.name,
        dc.pic_url,
        dc.description,
        dc.dietition_id,
        dc.course_title,
        dc.class_url,
        dc.class_type,
        dc.info_pic,
        dc.category_id,
        dc.price,
        dc.vip_price,
        dc.tags,
        dc.comment_num,
        dc.like_num,
        dc.score,
        dc.create_time,
        dc.actual_people,
        dc.virtual_people,
        dc.virtual_people + dc.actual_people as allPeople,
        dc.comment_num + dc.actual_people + dc.comment_num + dc.like_num + dc.score + dc.virtual_people as comprehensive,
        di.nick_name,
        di.pic,
        di.level
        from member_dietition_class dc
        left join member_dietition_info di on dc.dietition_id = di.user_id
        where dc.status = 0 and dc.deleted = 0  and  dc.dietition_id = #{classDTO.dietitionId}
        <choose>
            <when test="null != classDTO.orderBy and classDTO.orderBy == 'allPeople'">
                order by  allPeople desc
            </when>
            <when test="null != classDTO.orderBy and classDTO.orderBy == 'comprehensive'">
                order by comprehensive desc
            </when>
            <otherwise>
                order by dc.create_time desc
            </otherwise>
        </choose>
    </select>
    <select id="selectDietitionProductList" resultType="com.ainutribox.module.member.controller.app.dietitionclass.vo.DietitianProductVO">
        select
            id,
            product_text,
            dietitian_id,
            create_time
            from product_dietitian
        where deleted = 0 and status = 1 and dietitian_id = #{dietitionId}
    </select>

    <select id="getDietitionInfoList" resultType="com.ainutribox.module.member.controller.admin.dietition.vo.DietitionInfoRespVO">
        select
        dc.id,
        dc.user_id,
        dc.content,
        dc.score,
        dc.nick_name,
        dc.experience,
        dc.favorable_rate,
        dc.advice_num,
        dc.case_num,
        dc.level,
        dc.pic,
        dc.info_pic,
        dc.card_pic,
        dc.experience  + dc.level  as comprehensive
        from member_dietition_info dc
        where dc.status = 0 and dc.deleted = 0
        <if test="null != appDietitionInfoDTO.name and appDietitionInfoDTO.name != ''">
            and dc.nick_name like concat(#{appDietitionInfoDTO.name},'%')
        </if>
        <choose>
            <when test="null != appDietitionInfoDTO.orderBy and appDietitionInfoDTO.orderBy == 'level'">
                order by  dc.level desc
            </when>
            <when test="null != appDietitionInfoDTO.orderBy and appDietitionInfoDTO.orderBy == 'experience'">
                order by  dc.experience desc
            </when>
            <when test="null != appDietitionInfoDTO.orderBy and appDietitionInfoDTO.orderBy == 'comprehensive'">
                order by comprehensive desc
            </when>
            <otherwise>
                order by dc.create_time desc
            </otherwise>
        </choose>
    </select>

</mapper>